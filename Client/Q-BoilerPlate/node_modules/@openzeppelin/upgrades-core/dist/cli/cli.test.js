"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ava_1 = __importDefault(require("ava"));
const util_1 = require("util");
const child_process_1 = require("child_process");
const fs_1 = require("fs");
const path_1 = __importDefault(require("path"));
const os_1 = __importDefault(require("os"));
const rimraf_1 = __importDefault(require("rimraf"));
const hardhat_1 = require("hardhat");
const execAsync = (0, util_1.promisify)(child_process_1.exec);
const rimraf = (0, util_1.promisify)(rimraf_1.default);
const CLI = 'node dist/cli/cli.js';
async function getTempDir(t) {
    const temp = await fs_1.promises.mkdtemp(path_1.default.join(os_1.default.tmpdir(), 'upgrades-core-test-'));
    t.teardown(() => rimraf(temp));
    return temp;
}
(0, ava_1.default)('help', async (t) => {
    const output = (await execAsync(`${CLI} validate --help`)).stdout;
    t.snapshot(output);
});
(0, ava_1.default)('no args', async (t) => {
    const output = (await execAsync(CLI)).stdout;
    t.snapshot(output);
});
(0, ava_1.default)('validate - errors', async (t) => {
    const temp = await getTempDir(t);
    const buildInfo = await hardhat_1.artifacts.getBuildInfo(`contracts/test/cli/Validate.sol:Safe`);
    await fs_1.promises.writeFile(path_1.default.join(temp, 'validate.json'), JSON.stringify(buildInfo));
    const error = await t.throwsAsync(execAsync(`${CLI} validate ${temp}`));
    const expectation = [`Stdout: ${error.stdout}`, `Stderr: ${error.stderr}`];
    t.snapshot(expectation.join('\n'));
});
(0, ava_1.default)('validate - no upgradeable', async (t) => {
    const temp = await getTempDir(t);
    const buildInfo = await hardhat_1.artifacts.getBuildInfo(`contracts/test/cli/Storage088.sol:Storage088`);
    await fs_1.promises.writeFile(path_1.default.join(temp, 'validate.json'), JSON.stringify(buildInfo));
    const output = (await execAsync(`${CLI} validate ${temp}`)).stdout;
    t.snapshot(output);
});
(0, ava_1.default)('validate - ok', async (t) => {
    const temp = await getTempDir(t);
    const buildInfo = await hardhat_1.artifacts.getBuildInfo(`contracts/test/cli/Annotation.sol:Annotation`);
    await fs_1.promises.writeFile(path_1.default.join(temp, 'validate.json'), JSON.stringify(buildInfo));
    const output = (await execAsync(`${CLI} validate ${temp}`)).stdout;
    t.snapshot(output);
});
//# sourceMappingURL=cli.test.js.map