"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getContractInstance = void 0;
const assert_1 = __importDefault(require("assert"));
const utils_1 = require("../platform/utils");
const ethers_1 = require("./ethers");
/**
 * Gets a contract instance from a deployment, where the deployment may be remote.
 * If the deployment is remote, the instance have an overriden `deployed` method to wait for the remote deployment
 * and update its `deployTransaction` with the new transaction hash if it was detected to have changed.
 *
 * @param hre The Hardhat Runtime Environment
 * @param contract The contract factory
 * @param opts The deploy and platform options
 * @param deployment The deployment
 * @param deployTransaction The transaction that deployed the contract, if available
 * @returns The contract instance
 */
function getContractInstance(hre, contract, opts, deployment) {
    const instance = (0, ethers_1.attach)(contract, deployment.address);
    // @ts-ignore Won't be readonly because instance was created through attach.
    instance.deploymentTransaction = () => deployment.deployTransaction ?? null; // Convert undefined to null to conform to ethers.js types.
    if (opts.usePlatformDeploy && deployment.remoteDeploymentId !== undefined) {
        const origWait = instance.waitForDeployment.bind(instance);
        instance.waitForDeployment = async () => {
            (0, assert_1.default)(deployment.remoteDeploymentId !== undefined);
            const updatedTxHash = await (0, utils_1.waitForDeployment)(hre, opts, await instance.getAddress(), deployment.remoteDeploymentId);
            if (updatedTxHash !== undefined && updatedTxHash !== deployment.txHash) {
                const updatedTx = await hre.ethers.provider.getTransaction(updatedTxHash);
                // @ts-ignore Won't be readonly because instance was created through attach.
                instance.deploymentTransaction = () => updatedTx;
            }
            return await origWait();
        };
    }
    return instance;
}
exports.getContractInstance = getContractInstance;
//# sourceMappingURL=contract-instance.js.map